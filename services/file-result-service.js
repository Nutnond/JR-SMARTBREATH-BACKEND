// services/pdf.service.js
const ejs = require('ejs');
const puppeteer = require('puppeteer');
const path = require('path');
const fs = require('fs');
const { log } = require('console');

// 1. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≤ (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
const PREDICTED_VALUES = {
    "FVC": {
        "male": {
            "10": { "140": 2.13, "145": 2.37, "150": 2.62, "155": 2.90, "160": 3.18, "165": 3.49, "170": 3.82, "175": 4.17, "180": 4.54 },
            "15": { "140": 2.42, "145": 2.65, "150": 2.90, "155": 3.16, "160": 3.43, "165": 3.73, "170": 4.04, "175": 4.38, "180": 4.84 },
            "20": { "140": 2.63, "145": 2.85, "150": 3.08, "155": 3.33, "160": 3.60, "165": 3.90, "170": 4.18, "175": 4.55, "180": 4.83 },
            "25": { "140": 2.76, "145": 2.97, "150": 3.19, "155": 3.43, "160": 3.68, "165": 3.96, "170": 4.24, "175": 4.55, "180": 4.87 },
            "30": { "140": 2.82, "145": 3.02, "150": 3.23, "155": 3.46, "160": 3.71, "165": 3.97, "170": 4.24, "175": 4.53, "180": 4.89 },
            "35": { "140": 2.84, "145": 3.02, "150": 3.23, "155": 3.45, "160": 3.68, "165": 3.93, "170": 4.19, "175": 4.46, "180": 4.76 },
            "40": { "140": 2.81, "145": 2.99, "150": 3.18, "155": 3.38, "160": 3.61, "165": 3.84, "170": 4.09, "175": 4.36, "180": 4.64 },
            "45": { "140": 2.75, "145": 2.92, "150": 3.10, "155": 3.30, "160": 3.51, "165": 3.73, "170": 3.97, "175": 4.22, "180": 4.48 },
            "50": { "140": 2.67, "145": 2.83, "150": 3.01, "155": 3.19, "160": 3.39, "165": 3.60, "170": 3.82, "175": 4.06, "180": 4.31 },
            "55": { "140": 2.59, "145": 2.74, "150": 2.90, "155": 3.08, "160": 3.26, "165": 3.46, "170": 3.67, "175": 3.90, "180": 4.13 },
            "60": { "140": 2.52, "145": 2.65, "150": 2.80, "155": 2.97, "160": 3.14, "165": 3.32, "170": 3.52, "175": 3.73, "180": 3.94 },
            "65": { "140": 2.44, "145": 2.58, "150": 2.72, "155": 2.87, "160": 3.03, "165": 3.22, "170": 3.39, "175": 3.58, "180": 3.79 },
            "70": { "140": 2.44, "145": 2.53, "150": 2.66, "155": 2.82, "160": 2.95, "165": 3.11, "170": 3.28, "175": 3.46, "180": 3.66 },
            "75": { "140": 2.40, "145": 2.51, "150": 2.64, "155": 2.78, "160": 2.91, "165": 3.06, "170": 3.21, "175": 3.38, "180": 3.56 }
        },
        "female": {
            "10": { "140": 1.98, "145": 2.19, "150": 2.40, "155": 2.61, "160": 2.82, "165": 3.03, "170": 3.24, "175": 3.45, "180": 3.65 },
            "15": { "140": 2.16, "145": 2.37, "150": 2.57, "155": 2.78, "160": 2.98, "165": 3.18, "170": 3.38, "175": 3.58, "180": 3.83 },
            "20": { "140": 2.18, "145": 2.37, "150": 2.48, "155": 2.68, "160": 2.88, "165": 3.07, "170": 3.27, "175": 3.46, "180": 3.64 },
            "25": { "140": 2.35, "145": 2.54, "150": 2.73, "155": 2.92, "160": 3.11, "165": 3.30, "170": 3.48, "175": 3.66, "180": 3.84 },
            "30": { "140": 2.37, "145": 2.56, "150": 2.74, "155": 2.93, "160": 3.11, "165": 3.29, "170": 3.46, "175": 3.63, "180": 3.81 },
            "35": { "140": 2.36, "145": 2.54, "150": 2.72, "155": 2.89, "160": 3.07, "165": 3.24, "170": 3.40, "175": 3.56, "180": 3.72 },
            "40": { "140": 2.31, "145": 2.49, "150": 2.66, "155": 2.83, "160": 3.00, "165": 3.16, "170": 3.32, "175": 3.47, "180": 3.62 },
            "45": { "140": 2.26, "145": 2.43, "150": 2.59, "155": 2.75, "160": 2.91, "165": 3.07, "170": 3.21, "175": 3.36, "180": 3.50 },
            "50": { "140": 2.19, "145": 2.35, "150": 2.51, "155": 2.66, "160": 2.82, "165": 2.96, "170": 3.11, "175": 3.24, "180": 3.37 },
            "55": { "140": 2.12, "145": 2.27, "150": 2.43, "155": 2.58, "160": 2.72, "165": 2.86, "170": 3.00, "175": 3.13, "180": 3.27 },
            "60": { "140": 2.06, "145": 2.21, "150": 2.36, "155": 2.52, "160": 2.63, "165": 2.76, "170": 2.89, "175": 3.01, "180": 3.14 },
            "65": { "140": 2.02, "145": 2.16, "150": 2.31, "155": 2.44, "160": 2.56, "165": 2.69, "170": 2.82, "175": 2.91, "180": 3.02 },
            "70": { "140": 2.14, "145": 2.28, "150": 2.42, "155": 2.54, "160": 2.66, "165": 2.77, "170": 2.88, "175": 2.98, "180": 3.09 },
            "75": { "140": 2.02, "145": 2.16, "150": 2.28, "155": 2.40, "160": 2.52, "165": 2.63, "170": 2.75, "175": 2.82, "180": 2.90 }
        }
    },
    "FEV1": {
        "male": {
            "10": { "140": 1.83, "145": 2.06, "150": 2.31, "155": 2.58, "160": 2.86, "165": 3.17, "170": 3.49, "175": 3.83, "180": 4.19 },
            "15": { "140": 2.10, "145": 2.31, "150": 2.53, "155": 2.77, "160": 3.03, "165": 3.33, "170": 3.58, "175": 3.85, "180": 4.20 },
            "20": { "140": 2.28, "145": 2.47, "150": 2.67, "155": 2.88, "160": 3.11, "165": 3.35, "170": 3.60, "175": 3.88, "180": 4.06 },
            "25": { "140": 2.38, "145": 2.55, "150": 2.73, "155": 2.92, "160": 3.12, "165": 3.34, "170": 3.57, "175": 3.81, "180": 4.06 },
            "30": { "140": 2.41, "145": 2.56, "150": 2.73, "155": 2.99, "160": 3.12, "165": 3.37, "170": 3.47, "175": 3.68, "180": 3.95 },
            "35": { "140": 2.38, "145": 2.52, "150": 2.67, "155": 2.82, "160": 2.98, "165": 3.15, "170": 3.33, "175": 3.52, "180": 3.71 },
            "40": { "140": 2.30, "145": 2.43, "150": 2.56, "155": 2.70, "160": 2.85, "165": 3.01, "170": 3.18, "175": 3.35, "180": 3.52 },
            "45": { "140": 2.17, "145": 2.29, "150": 2.42, "155": 2.54, "160": 2.68, "165": 2.82, "170": 2.96, "175": 3.11, "180": 3.26 },
            "50": { "140": 2.02, "145": 2.13, "150": 2.25, "155": 2.37, "160": 2.49, "165": 2.62, "170": 2.75, "175": 2.88, "180": 3.02 },
            "55": { "140": 1.84, "145": 1.95, "150": 2.06, "155": 2.17, "160": 2.29, "165": 2.41, "170": 2.53, "175": 2.65, "180": 2.77 },
            "60": { "140": 1.65, "145": 1.76, "150": 1.87, "155": 1.98, "160": 2.09, "165": 2.21, "170": 2.32, "175": 2.42, "180": 2.54 },
            "65": { "140": 1.45, "145": 1.56, "150": 1.67, "155": 1.78, "160": 1.89, "165": 2.00, "170": 2.11, "175": 2.22, "180": 2.32 },
            "70": { "140": 1.27, "145": 1.38, "150": 1.49, "155": 1.61, "160": 1.72, "165": 1.83, "170": 1.93, "175": 2.04, "180": 2.14 },
            "75": { "140": 1.10, "145": 1.22, "150": 1.34, "155": 1.45, "160": 1.57, "165": 1.68, "170": 1.79, "175": 1.89, "180": 1.99 }
        },
        "female": {
            "10": { "140": 1.79, "145": 1.99, "150": 2.20, "155": 2.44, "160": 2.68, "165": 2.94, "170": 3.22, "175": 3.51, "180": 3.82 },
            "15": { "140": 1.96, "145": 2.14, "150": 2.33, "155": 2.53, "160": 2.75, "165": 2.98, "170": 3.19, "175": 3.42, "180": 3.65 },
            "20": { "140": 2.07, "145": 2.23, "150": 2.40, "155": 2.58, "160": 2.77, "165": 2.97, "170": 3.17, "175": 3.36, "180": 3.56 },
            "25": { "140": 2.12, "145": 2.26, "150": 2.42, "155": 2.58, "160": 2.75, "165": 2.92, "170": 3.11, "175": 3.31, "180": 3.52 },
            "30": { "140": 2.13, "145": 2.26, "150": 2.39, "155": 2.52, "160": 2.69, "165": 2.85, "170": 3.01, "175": 3.19, "180": 3.38 },
            "35": { "140": 2.10, "145": 2.22, "150": 2.34, "155": 2.47, "160": 2.60, "165": 2.74, "170": 2.89, "175": 3.04, "180": 3.20 },
            "40": { "140": 2.04, "145": 2.14, "150": 2.26, "155": 2.38, "160": 2.50, "165": 2.62, "170": 2.76, "175": 2.89, "180": 3.03 },
            "45": { "140": 1.95, "145": 2.06, "150": 2.16, "155": 2.27, "160": 2.38, "165": 2.49, "170": 2.62, "175": 2.74, "180": 2.86 },
            "50": { "140": 1.86, "145": 1.96, "150": 2.06, "155": 2.16, "160": 2.26, "165": 2.37, "170": 2.48, "175": 2.59, "180": 2.70 },
            "55": { "140": 1.76, "145": 1.85, "150": 1.95, "155": 2.05, "160": 2.15, "165": 2.26, "170": 2.36, "175": 2.47, "180": 2.58 },
            "60": { "140": 1.66, "145": 1.76, "150": 1.87, "155": 1.96, "160": 2.06, "165": 2.16, "170": 2.26, "175": 2.35, "180": 2.46 },
            "65": { "140": 1.57, "145": 1.67, "150": 1.78, "155": 1.88, "160": 1.98, "165": 2.08, "170": 2.18, "175": 2.28, "180": 2.37 },
            "70": { "140": 1.53, "145": 1.61, "150": 1.72, "155": 1.83, "160": 1.94, "165": 2.05, "170": 2.15, "175": 2.24, "180": 2.34 },
            "75": { "140": 1.46, "145": 1.58, "150": 1.70, "155": 1.82, "160": 1.94, "165": 2.05, "170": 2.16, "175": 2.26, "180": 2.36 }
        }
    },
    "PEF": {
        "male": {
            "10": { "140": 249, "145": 282, "150": 315, "155": 348, "160": 381, "165": 414, "170": 446.4, "175": 479.4, "180": 512.4 },
            "15": { "140": 282, "145": 342, "150": 374.4, "155": 406.8, "160": 438.6, "165": 471, "170": 502.8, "175": 535.2, "180": 567 },
            "20": { "140": 342, "145": 386.4, "150": 418.2, "155": 449.4, "160": 480.3, "165": 511.8, "170": 543, "175": 573.6, "180": 604.8 },
            "25": { "140": 386.4, "145": 417, "150": 447, "155": 477.6, "160": 507.6, "165": 538.2, "170": 567.6, "175": 597.6, "180": 627 },
            "30": { "140": 417, "145": 435, "150": 464.4, "155": 493.8, "160": 522.6, "165": 551.4, "170": 580.2, "175": 608.4, "180": 637.2 },
            "35": { "140": 435, "145": 442.2, "150": 470.4, "155": 499.2, "160": 526.8, "165": 554.4, "170": 582, "175": 609, "180": 635.4 },
            "40": { "140": 442.2, "145": 440.4, "150": 468, "155": 495.6, "160": 522, "165": 548.4, "170": 574.8, "175": 600.6, "180": 625.8 },
            "45": { "140": 440.4, "145": 432, "150": 458.4, "155": 484.8, "160": 510.6, "165": 535.8, "170": 561, "175": 585, "180": 609 },
            "50": { "140": 432, "145": 417.6, "150": 443.4, "155": 469.2, "160": 493.8, "165": 518.4, "170": 541.8, "175": 565.2, "180": 588 },
            "55": { "140": 417.6, "145": 399, "150": 424.8, "155": 450, "160": 474, "165": 498, "170": 520.8, "175": 543, "180": 564 },
            "60": { "140": 399, "145": 379.2, "150": 404.4, "155": 429, "160": 453, "165": 476.4, "170": 498.6, "175": 519.6, "180": 540 },
            "65": { "140": 379.2, "145": 358.2, "150": 384, "155": 408.6, "160": 432.6, "165": 455.4, "170": 477.6, "175": 498.6, "180": 518.4 },
            "70": { "140": 358.2, "145": 338.4, "150": 364.8, "155": 390.6, "160": 414.6, "165": 438, "170": 459.6, "175": 480.6, "180": 500.4 },
            "75": { "140": 338.4, "145": 321.6, "150": 394.2, "155": 375.6, "160": 400.8, "165": 424.8, "170": 447, "175": 468, "180": 487.8 }
        },
        "female": {
            "10": { "140": 257.4, "145": 282.6, "150": 307.2, "155": 331.8, "160": 355.8, "165": 379.8, "170": 403.2, "175": 426, "180": 448.2 },
            "15": { "140": 283.8, "145": 307.2, "150": 329.4, "155": 351.6, "160": 372.6, "165": 393.6, "170": 413.4, "175": 433.2, "180": 451.8 },
            "20": { "140": 303, "145": 324, "150": 343.8, "155": 364.2, "160": 383.4, "165": 401.4, "170": 418.8, "175": 435, "180": 450 },
            "25": { "140": 315, "145": 334.8, "150": 353.4, "155": 370.8, "160": 388.2, "165": 403.8, "170": 418.2, "175": 432, "180": 444.6 },
            "30": { "140": 321, "145": 339, "150": 356.4, "155": 372.6, "160": 387.6, "165": 401.4, "170": 414, "175": 425.4, "180": 435.6 },
            "35": { "140": 321.6, "145": 339, "150": 355.2, "155": 369.6, "160": 383.4, "165": 396, "170": 406.8, "175": 415.8, "180": 423.6 },
            "40": { "140": 317.4, "145": 334.2, "150": 349.2, "155": 363, "160": 375.6, "165": 386.4, "170": 396, "175": 403.8, "180": 409.8 },
            "45": { "140": 309, "145": 325.2, "150": 340.2, "155": 353.4, "160": 364.8, "165": 375, "170": 383.4, "175": 390, "180": 394.8 },
            "50": { "140": 297.6, "145": 313.8, "150": 328.8, "155": 341.4, "160": 352.8, "165": 361.8, "170": 369.6, "175": 375, "180": 378.6 },
            "55": { "140": 283.8, "145": 300, "150": 315, "155": 327.6, "160": 338.4, "165": 348, "170": 355.2, "175": 360, "180": 363 },
            "60": { "140": 268.2, "145": 285, "150": 300, "155": 313.2, "160": 324, "165": 333.6, "170": 340.8, "175": 345.6, "180": 348 },
            "65": { "140": 251.4, "145": 268.8, "150": 284.4, "155": 298.2, "160": 310.2, "165": 319.8, "170": 327, "175": 331.8, "180": 334.8 },
            "70": { "140": 234, "145": 252.6, "150": 293.4, "155": 283.8, "160": 296.4, "165": 306.6, "170": 315, "175": 320.4, "180": 323.4 },
            "75": { "140": 217.2, "145": 237, "150": 255, "155": 271.2, "160": 284.4, "165": 295.8, "170": 304.8, "175": 311.4, "180": 315.6 }
        }
    }
};

/**
 * 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Bilinear Interpolation)
 * ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á
 * ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ (10, 15, 20, ...) ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (140, 145, ...) ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ Interpolation ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
 * @param {string} paramKey - FVC, FEV1, ‡∏´‡∏£‡∏∑‡∏≠ PEF
 * @param {string} gender - 'male' ‡∏´‡∏£‡∏∑‡∏≠ 'female'
 * @param {number} age - ‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏£‡∏¥‡∏á
 * @param {number} height - ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏à‡∏£‡∏¥‡∏á (cm)
 * @returns {number|null} ‡∏Ñ‡πà‡∏≤ Predicted Value ‡∏´‡∏£‡∏∑‡∏≠ null ‡∏´‡∏≤‡∏Å‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
 */
const getPredictedValue = (paramKey, gender, age, height) => {
    try {
        const genderData = PREDICTED_VALUES[paramKey]?.[gender];
        if (!genderData) return null;

        // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Age ‡πÅ‡∏•‡∏∞ Height
        const ageKeys = Object.keys(genderData).map(Number).sort((a, b) => a - b);
        
        // 1. ‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        let lowerAge = ageKeys.reduce((prev, curr) => (curr <= age ? curr : prev), ageKeys[0]);
        let upperAge = ageKeys.find(key => key > age) || lowerAge;

        // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ Age ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        if (age < ageKeys[0]) lowerAge = upperAge = ageKeys[0];
        if (age > ageKeys[ageKeys.length - 1]) lowerAge = upperAge = ageKeys[ageKeys.length - 1];

        const lowerAgeStr = String(lowerAge);
        const upperAgeStr = String(upperAge);
        
        const lowerAgeHeightData = genderData[lowerAgeStr];
        const heightKeys = Object.keys(lowerAgeHeightData).map(Number).sort((a, b) => a - b);

        // 2. ‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        let lowerHeight = heightKeys.reduce((prev, curr) => (curr <= height ? curr : prev), heightKeys[0]);
        let upperHeight = heightKeys.find(key => key > height) || lowerHeight;
        
        // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ Height ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        if (height < heightKeys[0]) lowerHeight = upperHeight = heightKeys[0];
        if (height > heightKeys[heightKeys.length - 1]) lowerHeight = upperHeight = heightKeys[heightKeys.length - 1];

        const lowerHeightStr = String(lowerHeight);
        const upperHeightStr = String(upperHeight);

        // **Simple Interpolation (‡∏ñ‡πâ‡∏≤ Age ‡∏´‡∏£‡∏∑‡∏≠ Height ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ)
        
        // Step 1: Interpolate by Height for lowerAge and upperAge
        const v11 = lowerAgeHeightData[lowerHeightStr]; // Value at (lowerAge, lowerHeight)
        const v12 = lowerAgeHeightData[upperHeightStr]; // Value at (lowerAge, upperHeight)
        
        let predictedLowAge;
        if (lowerHeight === upperHeight) {
            predictedLowAge = v11;
        } else {
            // Linear interpolation based on height for lowerAge
            predictedLowAge = v11 + (height - lowerHeight) * (v12 - v11) / (upperHeight - lowerHeight);
        }

        let predictedUpperAge;
        if (lowerAge === upperAge) {
            predictedUpperAge = predictedLowAge;
        } else {
            const upperAgeHeightData = genderData[upperAgeStr];
            const v21 = upperAgeHeightData[lowerHeightStr]; // Value at (upperAge, lowerHeight)
            const v22 = upperAgeHeightData[upperHeightStr]; // Value at (upperAge, upperHeight)
            
            let predictedUpperAgeByHeight;
            if (lowerHeight === upperHeight) {
                predictedUpperAgeByHeight = v21;
            } else {
                // Linear interpolation based on height for upperAge
                predictedUpperAgeByHeight = v21 + (height - lowerHeight) * (v22 - v21) / (upperHeight - lowerHeight);
            }
            
            // Step 2: Interpolate by Age
            predictedUpperAge = predictedLowAge + (age - lowerAge) * (predictedUpperAgeByHeight - predictedLowAge) / (upperAge - lowerAge);
        }

        // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©
        return parseFloat(predictedUpperAge.toFixed(2));
        
    } catch (e) {
        console.error(`Error getting predicted value for ${paramKey}:`, e);
        return null;
    }
};

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Record
 * üéØ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏£‡∏±‡∏ö object ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á { record, patientInfo, isCurrentUser }
 * @param {object} reportConfig - Object ‡∏ó‡∏µ‡πà‡∏°‡∏µ record, patientInfo, ‡πÅ‡∏•‡∏∞ isCurrentUser
 * @returns {Promise<Buffer>} - ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Buffer ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå PDF
 */
const createReportPdf = async (reportConfig) => {
    try {
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å reportConfig
        const { record, patientInfo, isCurrentUser } = reportConfig;
        
        if (!record || !record.machine) {
            throw new Error("‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Record ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á PDF");
        }
        
        // **‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Predicted Values**
        const age = patientInfo?.age; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ age ‡πÄ‡∏õ‡πá‡∏ô number ‡πÉ‡∏ô patientInfo
        const height = patientInfo?.height; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ height ‡πÄ‡∏õ‡πá‡∏ô number ‡πÉ‡∏ô patientInfo (cm)
        const gender = patientInfo?.gender?.toLowerCase() === 'male' ? 'male' : 'female'; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ gender ‡πÄ‡∏õ‡πá‡∏ô string ‡πÉ‡∏ô patientInfo

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤ Predicted (FVC, FEV1, PEF)
        const predicted = {};
        if (age && height && gender) {
            predicted.FVC = getPredictedValue('FVC', gender, age, height);
            predicted.FEV1 = getPredictedValue('FEV1', gender, age, height);
            predicted.PEF = getPredictedValue('PEF', gender, age, height);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Predicted FEV1/FVC Ratio (Predicted FEV1 / Predicted FVC)
            if (predicted.FEV1 && predicted.FVC) {
                predicted.FEV1_FVC_RATIO = parseFloat((predicted.FEV1 / predicted.FVC * 100).toFixed(1)); // ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
            }
        } else {
            console.warn("Patient Age, Height, or Gender missing/invalid. Cannot calculate Predicted Values.");
        }
        // **********************************************

        const templatePath = path.join(__dirname, '..', 'views', 'record-result-template.ejs');
        const template = fs.readFileSync(templatePath, 'utf-8');

        // 2. ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô template (Render HTML)
        // üéØ ‡∏™‡πà‡∏á predicted values ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏î‡πâ‡∏ß‡∏¢
        const html = ejs.render(template, {
            record: record,
            machine: record.machine,
            patientInfo: patientInfo,
            isCurrentUser: isCurrentUser, // ‡∏™‡πà‡∏á isCurrentUser ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
            predicted: predicted, // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ Predicted ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ
        });

        // 3. ‡πÉ‡∏ä‡πâ Puppeteer ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
        // ... (‡πÇ‡∏Ñ‡πâ‡∏î Puppeteer ‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
        const browser = await puppeteer.launch({
            args: ['--no-sandbox', '--disable-setuid-sandbox'] // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡∏ö‡∏ô Server/Linux
        });
        const page = await browser.newPage();

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ HTML ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        await page.setContent(html, { waitUntil: 'networkidle0' });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
        const pdfBuffer = await page.pdf({
            format: 'A4',
            printBackground: true, // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞ CSS ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            margin: {
                top: '20mm',
                right: '10mm',
                bottom: '20mm',
                left: '10mm'
            }
        });

        await browser.close();

        return pdfBuffer;

    } catch (error) {
        console.error("Error creating PDF:", error);
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô error ‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (error.message.includes('‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')) {
            throw error;
        }
        throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÑ‡∏î‡πâ");
    }
};

module.exports = { createReportPdf };